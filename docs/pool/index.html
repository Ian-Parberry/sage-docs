<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The 8-ball Pool End Game: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="sagedoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="pooltable2.png"/></td>
  <td id="projectalign">
   <div id="projectname">The 8-ball Pool End Game
   </div>
   <div id="projectbrief">Game Physics with Bespoke Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="contents">
<div class="textblock"><p><a class="anchor" id="section1"></a></p><h1>1. Introduction</h1>
<p>This is the Pool End Game, a simple minigame that uses hand-written physics code based on Euler integration.</p>
<p><a class="anchor" id="fig1"></a></p><div class="image">
<img src="ss0.png" alt="" width="50%"/>
<div class="caption">
Fig. 1: The Pool End Game at the start of a game.</div></div>
<p>The remainder of this page is divided into five sections. <a class="el" href="#section2">Section 2</a> lists the controls and their corresponding actions, <a class="el" href="#section3">Section 3</a> tells you how to build it, <a class="el" href="#section4">Section 4</a> gives you a list of actions to take in the game to see some of its important features, <a class="el" href="#section5">Section 5</a> gives a breakdown of the code, <a class="el" href="#section6">Section 6</a> contains some programming problems, and <a class="el" href="#section7">Section 7</a> addresses the question "what next?".</p>
<p><a class="anchor" id="section2"></a></p><h1>2. Keyboard Controls</h1>
<center> <table class="doxtable">
<tr>
<td><center><b>Key</b></center> </td><td><center><b>Action</b></center> </td></tr>
<tr>
<td><center>Esc</center> </td><td>Exit </td></tr>
<tr>
<td><center>F1</center> </td><td>Help (this document) </td></tr>
<tr>
<td><center>F2</center> </td><td>Toggle frame rate </td></tr>
<tr>
<td><center>F3</center> </td><td>Toggle step mode </td></tr>
<tr>
<td><center>F4</center> </td><td>Toggle collision mode </td></tr>
<tr>
<td><center>Up arrow</center> </td><td>Move cue ball upwards on the base line </td></tr>
<tr>
<td><center>Down arrow</center> </td><td>Move cue ball downwards on the base line </td></tr>
<tr>
<td><center>Left arrow</center> </td><td>Rotate impulse vector counterclockwise </td></tr>
<tr>
<td><center>Right arrow</center> </td><td>Rotate impulse vector clockwise </td></tr>
<tr>
<td><center>Page up</center> </td><td>Rotate impulse vector counterclockwise fast </td></tr>
<tr>
<td><center>Page down</center> </td><td>Rotate impulse vector clockwise fast  </td></tr>
<tr>
<td><center>Space</center> </td><td>Fire cue ball/start new game/take step in Step Mode </td></tr>
<tr>
<td><center>PrtScr (hold down)</center> </td><td>Save screenshot to a PNG file </td></tr>
<tr>
<td><center>Esc</center> </td><td>Quit game and close the window </td></tr>
</table>
</center><p><a class="anchor" id="section3"></a></p><h1>3. Building the Game</h1>
<p>This code uses <a href="../sage/index.html">SAGE</a>. Make sure that you have followed the <a href="../install/index.html">SAGE Installation Instructions</a>. Navigate to the folder <span style="background-color:#D8E4D8;"><code>1. Pool End Game</code></span> in your copy of the <span style="background-color:#D8E4D8;"><code>sage-physics</code></span> repository. Run <span style="background-color:#D8E4D8;"><code>checkenv.bat</code></span> to verify that you have set the environment variables correctly. Open <span style="background-color:#D8E4D8;"><code>Pool End Game.sln</code></span> with Visual Studio and build the Release configuration. The Release executable file <span style="background-color:#D8E4D8;"><code>Pool End Game.exe</code></span> will appear. Alternatively, run <span style="background-color:#D8E4D8;"><code>Build.bat</code></span> to build both Release and Debug configurations.</p>
<p><a class="anchor" id="section4"></a></p><h1>4. Game Play</h1>
<p><a class="anchor" id="section4-1"></a></p><h2>4.1 Actual Game Play</h2>
<p>The aim of the game is to sink the 8-ball while not sinking the cue-ball. The initial state of the game is shown in <a class="el" href="#fig1">Fig. 1</a>, with the cue-ball on the base line to the left and the 8-ball on the dot at the right. An arrow shows the direction that the cue-ball will travel when hit by the imaginary cue, which will happen when the player hits the <code>Space</code> bar. We can call this vector the <em>impulse vector</em>. Before the initial hit, the player can move the cue-ball up and down on the base line by holding down the up and down arrow keys. For example, <a class="el" href="#fig2">Fig. 2</a> shows the cue-ball moved up along the base line.</p>
<p><a class="anchor" id="fig2"></a></p><div class="image">
<img src="ss1.png" alt="" width="50%"/>
<div class="caption">
Fig. 2: The Pool End Game at the start of a game with the cue ball moved upwards.</div></div>
<p>Notice that, as shown in <a class="el" href="#fig2">Fig. 2</a>, the impulse vector always points to the 8-ball while the cue-ball is moved up or down along the base line. The player can rotate the impulse vector by holding down the appropriate key (see <a class="el" href="#section2">Section 2</a>). For example <a class="el" href="#fig3">Fig.3</a> shows the impulse vector rotated slightly counterclockwise from the center of the 8-ball.</p>
<p><a class="anchor" id="fig3"></a></p><div class="image">
<img src="ss2.png" alt="" width="50%"/>
<div class="caption">
Fig. 3: The Pool End Game at the start of a game with the impulse vector rotated counterclockwise.</div></div>
<p>The impulse vector is hidden when the balls are in motion. The impulse vector reappears when the balls come to rest, pointing to the center of the 8-ball. At this point the player can rotate the impulse vector using the same keys as before, and shoot using the <code>Space</code> bar. Eventually (depending on the skill of the player) either the cue-ball will go into one of the six pockets at the corners and horizontal centers of the table, in which case the player loses the game (see <a class="el" href="#fig4">Fig. 4</a>, right), or the 8-ball goes into a pocket while the cue-ball remains on the table, in which case the player wins (see <a class="el" href="#fig4">Fig. 4</a>, left).</p>
<p><a class="anchor" id="fig4"></a></p><div class="image">
<img src="winlose.png" alt="" width="90%"/>
<div class="caption">
Fig. 4: The Pool End Game after winning (left) and losing (right).</div></div>
<p>After a short pause, or when the player hits the <code>Space</code> bar, the game begins again as shown in <a class="el" href="#fig1">Fig. 1</a>.</p>
<p><a class="anchor" id="section4-2"></a></p><h2>4.2 Step Mode</h2>
<p>In addition to being a minigame that you can actually play, the Pool End Game allows the player to toggle in and out of <em>step mode</em> in which the ball advances by 1/30th of a second each time the space bar is pressed and leaves a trail of markers as shown in <a class="el" href="#fig5">Fig. 5</a>. Step Mode is intended to help the player visualize the discrete nature of video game time (see <a class="el" href="#section5-1">Section 5.1</a>). When the game is in step mode a pair of footprints will appear at the lower left corner of the table, as shown in <a class="el" href="#fig5">Fig. 5</a>.</p>
<p><a class="anchor" id="fig5"></a></p><div class="image">
<img src="screenshot.png" alt="" width="50%"/>
<div class="caption">
Fig. 5. Step Mode after the space bar has been depressed about 16 times.</div></div>
<p><a class="anchor" id="section4-3"></a></p><h2>4.3 Collision Mode</h2>
<p>The player can also toggle in and out of <em>collision mode</em>, which displays yellow circles at the positions of the balls at time of impact with each other and with the rails. When the game is in collision mode a small black circle will appear at the lower left corner of the table, as shown in <a class="el" href="#fig6">Fig. 6</a>.</p>
<p><a class="anchor" id="fig6"></a></p><div class="image">
<img src="screenshot0.png" alt="" width="50%"/>
<div class="caption">
Fig. 6. Collision mode after a ball-to-ball collision and 3 ball-to-rail collisions.</div></div>
<p>Suppose we number the yellow collision circles from <a class="el" href="#fig6">Fig. 6</a>, as shown in <a class="el" href="#fig7">Fig. 7</a>. Circles 1 and 2 are from a collision between the cue-ball (the left circle) and the 8-ball (the right circle). The cue-ball travels up and to the right and collides with the top rail at circle 3, rebounding to the position shown. At the same time the 8-ball collides with the right rail at circle 4, then the bottom rail at circle 5, rebounding to the position shown.</p>
<p><a class="anchor" id="fig7"></a></p><div class="image">
<img src="screenshot0a.png" alt="" width="50%"/>
<div class="caption">
Fig. 7. Collision mode with numbered collisions.</div></div>
<p><a class="anchor" id="section5"></a></p><h1>5. Code Breakdown</h1>
<p>This section assumes that you have fully read and understood the documentation for <a href="../sage/index.html">SAGE</a> and <a href="../blank/index.html">The Blank Game</a>. The most interesting parts of this code from a game physics perspective are the object motion code in <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> and the collision detection and response code in <code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code>. These are covered in <a class="el" href="#section5-1">Section 5.1</a> and <a class="el" href="#section5-2">Section 5.2</a>, respectively.</p>
<p><a class="anchor" id="section5-1"></a></p><h2>5.1 CObject</h2>
<p>The <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> is the abstract representation of an object, which in this game means the cue-ball and the 8-ball. <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> stores, among other things, an object's position <code><a class="el" href="class_c_object.html#a0219c1e480987fa4f0f126a315bc2398" title="Position.">CObject::m_vPos</a></code> and velocity vector <code><a class="el" href="class_c_object.html#ab0773fd6d20a444c7938e86f40acc2b8" title="Current velocity.">CObject::m_vVel</a></code>. Don't be distracted by <code><a class="el" href="class_c_object.html#a7c7ddba1750b75df1cc13e49a98b7056" title="Previous position. Only needed for Step Mode.">CObject::m_vOldPos</a></code>, which is used solely to determine where to drop a circle particle in step mode (see <a class="el" href="#section4-2">Section 4.2</a>). <code><a class="el" href="class_c_object.html#ae33d05b96b8b11fe621e42525a908041" title="Move object.">CObject::Move</a></code> handles ball motion and <code><a class="el" href="class_c_object.html#a1cf5dcfbac665543093e48c75a084550" title="Deliver an impulse.">CObject::DeliverImpulse</a></code> delivers an impulse for when the player hits the cue-ball. These are described in <a class="el" href="#section5-1-1">Section 5.1.1</a> and <a class="el" href="#section5-1-2">Section 5.1.2</a>, respectively.</p>
<p><a class="anchor" id="section5-1-1"></a></p><h3>5.1.1 CObject::Move</h3>
<p>Function <code><a class="el" href="class_c_object.html#ae33d05b96b8b11fe621e42525a908041" title="Move object.">CObject::Move</a></code> gets called once per animation frame for each of the balls, resulting the the balls skipping across the table in discrete jumps. However, if the frame rate is high enough, the human brain will interpret the jaggy motion as one continuous sweep. See <a href="../integration/index.html">Euler Integration</a> for the full explanation. Step mode will help you to visualize this (see <a class="el" href="#section4-2">Section 4.2</a>).</p>
<p><a class="anchor" id="section5-1-2"></a></p><h3>5.1.2 CObject::DeliverImpulse</h3>
<p>Function <code><a class="el" href="class_c_object.html#a1cf5dcfbac665543093e48c75a084550" title="Deliver an impulse.">CObject::DeliverImpulse</a></code> for the cue-ball object gets called from <code><a class="el" href="class_c_object_manager.html#a059d66d8e43e9d8e3ee956e840ff9f95" title="Shoot the cue ball.">CObjectManager::Shoot</a></code>, which is called from <code><a class="el" href="class_c_game.html#a74a75ef02b07f0f785de8aa6e7631b5d" title="The keyboard handler.">CGame::KeyboardHandler</a></code> in response to the player pressing the space bar when all balls are stopped and are not in pockets. Rather than messing around with forces, this function takes an angle \(a\) and a magnitude <code>m</code> and sets the velocity of the ball to <code>m</code> times the vector with orientation <code>a</code>. The latter is obtained by calling <a href="../sage/_sage_geometry_8h.html#a8326e6cd74f9907292a207381f7e8b6f"><code>Sage::AngleToVector(a)</code></a>. <code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code> keeps the current cue orientation in <code><a class="el" href="class_c_object_manager.html#aa8752b29ae75fdb1fbf20bc278a4cc1f" title="Cue ball impulse angle.">CObjectManager::m_fCueAngle</a></code> which it provides as parameter <code>a</code> to <code><a class="el" href="class_c_object.html#a1cf5dcfbac665543093e48c75a084550" title="Deliver an impulse.">CObject::DeliverImpulse</a></code>. <code><a class="el" href="class_c_object_manager.html#aa8752b29ae75fdb1fbf20bc278a4cc1f" title="Cue ball impulse angle.">CObjectManager::m_fCueAngle</a></code> is adjusted using <code><a class="el" href="class_c_object_manager.html#aa7fe841b430ea2e22d9fdebcf497b797" title="Move cue-ball up or down.">CObjectManager::AdjustCueBall</a></code>, which is called from <code><a class="el" href="class_c_game.html#a74a75ef02b07f0f785de8aa6e7631b5d" title="The keyboard handler.">CGame::KeyboardHandler</a></code> in response to player input (see <a class="el" href="#section2">Section 2</a>).</p>
<p><a class="anchor" id="section5-2"></a></p><h2>5.2 CObjectManager</h2>
<p><code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code>'s most important task in this game is collision detection and response. <code><a class="el" href="class_c_object_manager.html#ae2487201156a62dc632609bc42a7d80b" title="Ball, rail, and pocket collision response.">CObjectManager::BroadPhase</a></code> is called once per frame and it handles the detection of and response to collisions between the balls and other balls, the rails (the horizontal and vertical walls near the edges of the table in <a class="el" href="#fig1">Fig. 1</a>), and the pockets. <code><a class="el" href="class_c_object_manager.html#ae2487201156a62dc632609bc42a7d80b" title="Ball, rail, and pocket collision response.">CObjectManager::BroadPhase</a></code> calls <code><a class="el" href="class_c_object_manager.html#acee7c392319024d71772e2d290a1cc7d" title="Collision response for two balls.">CObjectManager::NarrowPhase</a></code> which performs collision detection and response between the two balls. <code><a class="el" href="class_c_object_manager.html#ae2487201156a62dc632609bc42a7d80b" title="Ball, rail, and pocket collision response.">CObjectManager::BroadPhase</a></code> also calls <code><a class="el" href="class_c_object_manager.html#a7704293d68f5527f323527028ea21398" title="Collision response for ball with rail.">CObjectManager::RailCollide</a></code> for detection of and response to collision between a ball and a rail, and <code><a class="el" href="class_c_object_manager.html#a21ff35019a29b63d608802bc75e94694" title="Collision response for ball with pocket.">CObjectManager::PocketCollide</a></code> for detection of and response to collision between a ball and a pocket. These are covered in <a class="el" href="#section5-2-1">Section 5.2.1</a>, <a class="el" href="#section5-2-2">Section 5.2.2</a>, and <a class="el" href="#section5-2-3">Section 5.2.3</a>, respectively.</p>
<p><a class="anchor" id="section5-2-1"></a></p><h3>5.2.1 CObjectManager::NarrowPhase</h3>
<p>Suppose we call the balls that are colliding \(B_1\) and \(B_2\), and that they are moving with velocities \(\vec{v}_1\) and \(\vec{v}_2\), respectively. Let \(\vec{v}\) be the velocity of \(B_2\) relative to \(B_1\), that is \(\vec{v} = \vec{v}_2 - \vec{v}_1\). Suppose that at the end of the frame we detect an overlap between \(B_1\) and \(B_2\), and that this is the first frame in which an overlap occurs between \(B_1\) and \(B_2\). In the <a class="el" href="#fig8">Fig. 8</a> \(B_1\) is brown, \(B_2\) is yellow, and \(B_2\) is moving along the dotted line with velocity \(\vec{v}\) relative to \(B_1\). Note that at the time this overlap between the balls has been detected, \(B_2\) may be approaching or moving away from \(B_1\) (we have drawn it as moving away). <br  />
</p>
<p><a class="anchor" id="fig8"></a></p><div class="image">
<img src="circles3.png" alt="" width="35%"/>
<div class="caption">
Fig. 8. Ball to ball collision.</div></div>
<p>The actual time of impact (TOI for short) between \(B_1\) and \(B_2\) would probably be between animation frames. We would expect that the position of \(B_2\) at the TOI would be the dotted circle in <a class="el" href="#fig8">Fig. 8</a>. We need to calculate \(d\), the distance that \(B_2\) needs to be moved back to its position at TOI. Let \(\vec{c}\) be the vector fom the center of \(B_2\) to the center of \(B_1\), \(\delta\) be the distance between the center of \(B_1\) and the center of \(B_2\) at TOI, and \(\theta\) be the angle between \(\vec{c}\) and \(-\vec{v}\), as shown in <a class="el" href="#fig8">Fig. 8</a>. By the law of cosines,  </p><p class="formulaDsp">
\[\delta^2 = d^2 + \left\Vert\vec{c}\right\Vert^2 -
2d\left\Vert\vec{c}\right\Vert \cos \theta.\]
</p>
<p> Since \(\left\Vert\vec{c}\right\Vert = -\hat{v} \cdot \vec{c}\) and \(\left\Vert\vec{c}\right\Vert^2 = \vec{c} \cdot \vec{c}\),    </p><p class="formulaDsp">
\[
d^2 + \vec{c} \cdot \vec{c} +
2d\hat{v} \cdot \vec{c} - \delta^2 = 0.
\]
</p>
<p> This is a quadratic equation in \(d\) whose roots are  </p><p class="formulaDsp">
\[d = -\hat{v} \cdot \vec{c} \pm \sqrt{(\hat{v} \cdot \vec{c})^2 - 
\vec{c} \cdot \vec{c} + \delta^2}.\]
</p>
<p> We need the first root  </p><p class="formulaDsp">
\[d = -\hat{v} \cdot \vec{c} + \sqrt{(\hat{v} \cdot \vec{c})^2 - 
\vec{c} \cdot \vec{c} + \delta^2}.\]
</p>
<p> Note that if  \((\hat{v} \cdot \vec{c})^2 - 
\vec{c} \cdot \vec{c} + \delta^2 &lt; 0 \), then there is no collision. This should not happen if we perform this computation only if there is overlap between the two circles, but it may still happen due to floating point roundoff error.</p>
<p>Now we can compute \(\delta_t = \left\Vert\vec{v}\right\Vert/d\), the time elapsed since TOI. Suppose that at the time the collision was detected \(B_1\) was at position \(\vec{p}_1\) and \(B_2\) was at position \(\vec{p}_2\). Let \(\vec{q}_1\) be the position of \(B_1\) at TOI, and \(\vec{q}_2\) the position of \(B_2\) at TOI. Then, we can compute \(\vec{q}_1 = \vec{p}_1 - \delta_t\vec{v}_1\) and \(\vec{q}_2 = \vec{p}_2 - \delta_t\vec{v}_2\).</p>
<p>Now we need to compute the velocities of \(B_1\) and \(B_2\) after the impact. Let \(\vec{n}\) be the vector from \(\vec{q}_2\) to \(\vec{q}_1\), that is, \(\vec{n} = \vec{q}_1 - \vec{q}_2\). At TOI \(B_1\) and \(B_2\) swap the components of their velocity parallel to \(\vec{n}\), by the Laws of Conservation of Kinetic Energy and Conservation of Momentum (see <a href="../newton/index.html#section1">here for details</a>).</p>
<p>Let \({\vec{v}_1}&#39;\) and \({\vec{v}_2}&#39;\) be the velocities of \(B_1\) and \(B_2\), respectively, after the impact. Then \({\vec{v}_1}&#39; = \vec{v}_1 + (\vec{v} \cdot \hat{n})\hat{n}\) and \({\vec{v}_2}&#39; = \vec{v}_2 - (\vec{v} \cdot \hat{n})\hat{n}\). \(B_1\) and \(B_2\) will have been moving from their positions at TOI with those respective new velocities for time \(\delta_t\). Their new positions are therefore \(\vec{q}_1 + \delta_t {\vec{v}_1}\) and \(\vec{q}_2 + \delta_t {\vec{v}_2}\), respectively.</p>
<p><a class="anchor" id="section5-2-2"></a></p><h3>5.2.2 CObjectManager::RailCollide</h3>
<p>Collision of a ball with a line is easier if we consider only horizontal and vertical lines. Fortunately, the rails in the Pool End Game are horizontal and vertical. Consider the case of a ball colliding with a horizontal line from below. Again, the actual collision occurs between frames and overlap between the ball and the line might be detected at the end of a frame. Suppose that, as show in <a class="el" href="#fig9">Fig. 9</a>, the yellow ball is moving along the dotted line from bottom left to top right of the figure at velocity \(\vec{v} = [v_x, v_y]\) and the collision is detected when it is at position \(\vec{p} = [p_x, p_y]\). Further suppose that the horizontal line has equation \(y = w_y\). We want to compute the point of impact (POI for short) so that, for example, we can play a particle effect or sound effect at POI. From <a class="el" href="#fig9">Fig. 9</a>, the POI has coordinates \([p_x - d_1 - d_2, w_y]\).</p>
<p><a class="anchor" id="fig9"></a></p><div class="image">
<img src="wall.png" alt="" width="40%"/>
<div class="caption">
Fig. 9: POI of ball colliding with horizontal line from below.</div></div>
<p>Consider the upper right triangle in <a class="el" href="#fig9">Fig. 9</a>. By observation, \(\tan \theta = (p_y - w_y)/d_2\). However, \(\tan \theta\) is also equal to \(v_y/v_x\). Therefore, \(v_y/v_x = (p_y - w_y)/d_2\), that is, \(d_2 = (p_y - w_y)v_x/v_y\). Now consider the lower left triangle in <a class="el" href="#fig9">Fig. 9</a>. By observation, \(\tan \theta = r/d_1\), where \(r\) is the radius of the ball. Therefore, \(v_y/v_x = r/d_1\), that is, \(d_1 = rv_x/v_y\). Putting these things together, the coordinates of the POI are \([p_x - (r + p_y - w_y)v_x/v_y, w_y]\).</p>
<p>Now consider <a class="el" href="#fig10">Fig. 10</a>. The gray circle is the position of the ball when the collision is detected, the dotted circle is its position at TOI, and the yellow circle is its corrected position at the end of the frame. The ball will have moved downwards a distance equal to its upward travel from TOI, that is \(p_y - w_y + r\). The ball's corrected position is therefore \(\vec{p}&#39; = [p_x, 2(w_y - r) - p_y]\). Similarly, the component of its velocity perpendicular to the line gets reversed, so its corrected velocity at the end of the frame is \([v_x, -v_y]\).</p>
<p><a class="anchor" id="fig10"></a></p><div class="image">
<img src="wall2.png" alt="" width="40%"/>
<div class="caption">
Fig. 10: New position and velocity of ball colliding with horizontal line from below.</div></div>
<p>This concludes collision of a ball with a horizontal line from below. The other three cases needed for this game, collision of a ball with a horizontal line from above (the bottom rail), collision of a ball with a vertical line from the left (the right rail), and collision of a ball with a vertical line from the right (the left rail), are similar. See the code for <code><a class="el" href="class_c_object_manager.html#a7704293d68f5527f323527028ea21398" title="Collision response for ball with rail.">CObjectManager::RailCollide</a></code> for more details.</p>
<p><a class="anchor" id="section5-2-3"></a></p><h3>5.2.3 CObjectManager::PocketCollide</h3>
<p>Collision of a ball with a pocket is fairly easy. For example, if a ball collides with the top and right rails, then it is deemed to have fallen into the pocket at the top right of the table. While this is much simpler than the behavior of a ball in a real world game of pool, it is sufficient for this game.</p>
<p><a class="anchor" id="section6"></a></p><h1>6. Problems</h1>
<p><a class="anchor" id="problem6-1"></a></p><h2>Problem 6.1</h2>
<p><a class="anchor" id="fig11"></a></p><div class="image">
<img src="hitpoint.gif" alt=""/>
<div class="caption">
Fig. 11: A circle drawn at the point of impact.</div></div>
<div style="padding-left: 30px;" markdown="1"> Add code that draws a circle where the cue-ball would be at the time of impact with the 8-ball, as shown in <a class="el" href="#fig11">Fig. 11</a>. The new circle is only drawn when the cue-ball would hit the 8-ball before hitting a rail, and only when both balls are stationary and not in a pocket. Your code should go into <code><a class="el" href="class_c_object_manager.html#a849420297e5c9bf08f073d90b448daf8" title="Draw all objects.">CObjectManager::Draw</a></code>. Once you have computed the position of the cue ball at time of impact into a local variable, say <code>vCueBallPosAtTOI</code> of type <code>Vector2</code>, you can draw a circle there with the following code: <pre class="fragment">Sage::CSpriteDesc2D sd;
sd.m_nSpriteIndex = (UINT)eSprite::Circle;
sd.m_vPos = vCueBallPosAtTOI;
sd.m_f4Tint = XMFLOAT4(Colors::AntiqueWhite);

m_pRenderer-&gt;Draw(&amp;sd); 
</pre></div><div style="padding-left: 30px;" markdown="1"><h3>Hint:</h3>
</div><div style="padding-left: 30px;" markdown="1"> There is already code to compute the center of the ball at TOI. This can be used whether or not the balls currently overlap. </div><p><a class="anchor" id="problem6-2"></a></p><h2>Problem 6.2</h2>
<p><a class="anchor" id="fig12"></a></p><div class="image">
<img src="lines.gif" alt=""/>
<div class="caption">
Fig. 12: Lines showing the paths of the cue-ball (white) and the 8-ball (magenta).</div></div>
<div style="padding-left: 30px;" markdown="1"> After completing <a class="el" href="#problem6-1">Problem 6.1</a> above, add code that draws a line showing the path of the cue-ball before impact, and lines showing the paths of both balls after impact. The latter must must end at a rail as shown in <a class="el" href="#fig12">Fig. 12</a>.</div><div style="padding-left: 30px;" markdown="1"><h3>Hints:</h3>
</div><div style="padding-left: 30px;" markdown="1"></div><div style="padding-left: 30px;" markdown="1">To draw a line from the current position of the cue-ball <code>m_pCueBall-&gt;m_vPos</code> to the its position at time of impact <code>vCueBallPosAtTOI</code> found in <a class="el" href="#problem6-1">Problem 6.1</a>, add the following line of code in the appropriate place in <code><a class="el" href="class_c_object_manager.html#a849420297e5c9bf08f073d90b448daf8" title="Draw all objects.">CObjectManager::Draw</a></code>. <pre class="fragment">m_pRenderer-&gt;DrawLine(eSprite::Line, m_pCueBall-&gt;m_vPos, vCueBallPosAtTOI, Colors::AntiqueWhite);
</pre></div><div style="padding-left: 30px;" markdown="1">Next, add the private member function <pre class="fragment">DrawLineToRail(const Vector2&amp; p, float theta, XMVECTORF32 c)
</pre></div><div style="padding-left: 30px;" markdown="1">to <code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code> and write code to draw a line from point <code>p</code> at orientation <code>theta</code> in color <code>c</code>. You can do this by computing the point of intersection of the line with a rail in <code>vIntercept</code> and calling <pre class="fragment">m_pRenderer-&gt;DrawLine(eSprite::Line, p, vIntercept, c);
</pre></div><div style="padding-left: 30px;" markdown="1">You can find the coordinates of the rails from the inherited private member variables <code><a class="el" href="class_c_common.html#ae9442a1691ff4cdba3cd33848e00bed8" title="Horizontal margin.">CCommon::m_fXMargin</a></code>, <code><a class="el" href="class_c_common.html#a73ea76e56858709e78ddfc49d13b1222" title="Vertical margin.">CCommon::m_fYMargin</a></code>, <code>Sage::CSettings::m_nWinWidth</code>, and <code>Sage::CSettings::m_nWinHeight</code></div><div style="padding-left: 30px;" markdown="1">Call your new function <code>CObjectManager::DrawLineToRail</code> from <code><a class="el" href="class_c_object_manager.html#a849420297e5c9bf08f073d90b448daf8" title="Draw all objects.">CObjectManager::Draw</a></code> once for the cue-ball and once for the 8-ball when appropriate. The lines for the cue-ball should have color parameter <code>c</code> equal to <code>Colors::AntiqueWhite</code> for the cue-ball lines and <code>Colors::Magenta</code> for the 8-ball lines. </div><p><a class="anchor" id="section7"></a></p><h1>7. What Next?</h1>
<p>Next, take a look at the <a href="../shapes/index.html">Shapes Library</a>. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
