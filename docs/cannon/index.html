<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Box2D Cannon Game: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="sagedoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="cannon.png"/></td>
  <td id="projectalign">
   <div id="projectname">Box2D Cannon Game
   </div>
   <div id="projectbrief">Game Physics with a 2D Physics Engine</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="contents">
<div class="textblock"><p><a class="anchor" id="section1"></a></p><h1>1. Introduction</h1>
<p>The Cannon Game demonstrates how to make a simple minigame using Box2D building on concepts from the <a href="../bouncy/index.html">Box2D Bouncy Things Toy</a> and the <a href="../box2djoints/index.html">Box2D Joint Toy</a>. It consists of a cannon resting on a stone wall, a stack of crates, and a heads-up display consisting of a temperature gauge and a stopwatch, as shown in <a class="el" href="#fig1">Fig. 1</a>. The remainder of this page is divided into five sections. <a class="el" href="#section2">Section 2</a> lists the controls and their corresponding actions, <a class="el" href="#section3">Section 3</a> tells you how to build it, <a class="el" href="#section4">Section 4</a> gives you a list of actions to take in the game to see some of its important features, <a class="el" href="#section5">Section 5</a> gives a breakdown of the code, and <a class="el" href="#section6">Section 6</a> addresses the question "what next?".</p>
<p><a class="anchor" id="fig1"></a></p><div class="image">
<img src="screenshot.png" alt="" width="60%"/>
<div class="caption">
Fig. 1: Screen shot.</div></div>
<p>The remainder of this page is divided into five sections. <a class="el" href="#section2">Section 2</a> lists the controls and their corresponding actions, <a class="el" href="#section3">Section 3</a> tells you how to build it, <a class="el" href="#section4">Section 4</a> gives you a list of actions to take in the game to see some of its important features, <a class="el" href="#section5">Section 5</a> gives a breakdown of the code, and <a class="el" href="#section6">Section 6</a> addresses the question "what next?".</p>
<p><a class="anchor" id="section2"></a></p><h1>2. Keyboard Controls</h1>
<center> <table class="doxtable">
<tr>
<td><center><b>Key</b></center> </td><td><center><b>Action</b></center> </td></tr>
<tr>
<td><center>F1</center> </td><td>Help (this document) </td></tr>
<tr>
<td><center>F2</center> </td><td>Toggle draw mode from "sprites only", to "sprites and lines", to "lines only" </td></tr>
<tr>
<td><center>Enter</center> </td><td>Restart when over </td></tr>
<tr>
<td><center>Space</center> </td><td>Fire cannon </td></tr>
<tr>
<td><center>Up arrow</center> </td><td>Rotate cannon barrel up while key is depressed </td></tr>
<tr>
<td><center>Down arrow</center> </td><td>Rotate cannon barrel down while key is depressed </td></tr>
<tr>
<td><center>Left arrow</center> </td><td>Start cannon moving left </td></tr>
<tr>
<td><center>Right arrow</center> </td><td>Start cannon moving right </td></tr>
<tr>
<td><center>S</center> </td><td>Stop cannon </td></tr>
<tr>
<td><center>PrtScr (hold down)</center> </td><td>Save screenshot to a PNG file </td></tr>
<tr>
<td><center>Esc</center> </td><td>Quit game and close the window </td></tr>
</table>
</center><p><a class="anchor" id="section3"></a></p><h1>3. Building the Game</h1>
<p>This code uses <a href="../sage/index.html">SAGE</a> and <a href="https://github.com/erincatto/Box2D">Box2D</a>. Make sure that you have followed the <a href="../install/index.html">SAGE Installation Instructions</a> and the <a href="../installphysics/index.html">Box2D Installation Instructions</a>. Navigate to the folder <span style="background-color:#D8E4D8;"><code>9. Box2D Cannon Game</code></span> in your copy of the <span style="background-color:#D8E4D8;"><code>sage-physics</code></span> repository. Run <span style="background-color:#D8E4D8;"><code>checkenv.bat</code></span> to verify that you have set the environment variables correctly. Open <span style="background-color:#D8E4D8;"><code>Box2D Cannon Game.sln</code></span> with Visual Studio and build the Release configuration. Alternatively, run <span style="background-color:#D8E4D8;"><code>Build.bat</code></span> to build both Release and Debug configurations.</p>
<p><a class="anchor" id="section4"></a></p><h1>4. Game Play</h1>
<p><a class="anchor" id="fig2"></a></p><div class="image">
<img src="win.png" alt="" width="60%"/>
<div class="caption">
Fig. 2: The win screen.</div></div>
<p><a class="anchor" id="fig3"></a></p><div class="image">
<img src="lose.png" alt="" width="60%"/>
<div class="caption">
Fig. 3: The exploding cannon.</div></div>
<p>You must get all of the crates below a line approximately at the horizon to win. If you win, you'll see a text message telling you how many shots you used and how much time you took (see <a class="el" href="#fig2">Fig. 2</a>). There's a HUD at top left of the window with a gauge that tells you the cannon's current temperature and the maximum temperature experienced so far (see <a class="el" href="#fig4">Fig. 4</a>). Firing the cannon increases the temperature and it cools over the next few seconds. If the cannon overheats, then it will explode when next fired and you lose (see <a class="el" href="#fig3">Fig. 3</a>). You have 60 seconds in which to knock down the tower. There's a stopwatch to the right of the temperature gauge so you can see how much time is remaining.</p>
<p><a class="anchor" id="fig4"></a></p><div class="image">
<img src="tempgauge.png" alt="" width="25%"/>
<div class="caption">
Fig. 4: The temperature gauge.</div></div>
<p><a class="anchor" id="fig5"></a></p><div class="image">
<img src="clock.gif" alt="" width="130"/>
<div class="caption">
Fig. 5: The stopwatch.</div></div>
<p><a class="anchor" id="section5"></a></p><h1>5. Code Breakdown</h1>
<p>By now you should have enough experience with Box2D in the <a href="../bouncy/index.html">Box2D Bouncy Things Toy</a> and the <a href="../box2djoints/index.html">Box2D Joint Toy</a> to understand most of the code in the Box2D Cannon Game, the shapes for which are shown in <a class="el" href="#fig6">Fig. 6</a>. Two interesting things remain, however, implementation of the cannon, and the generation of collision sounds (recall that neither the <a href="../bouncy/index.html">Box2D Bouncy Things Toy</a> nor the <a href="../box2djoints/index.html">Box2D Joint Toy</a> had any audio. Each of these will be addressed in a separate section below.</p>
<p><a class="anchor" id="fig6"></a></p><div class="image">
<img src="shapes.png" alt="" width="60%"/>
<div class="caption">
Fig. 6: Box2D shapes for the Cannon Game.</div></div>
<p><a class="anchor" id="section5-1"></a></p><h2>5.1 The Cannon</h2>
<p>The cannon is implemented in <code><a class="el" href="class_c_cannon.html" title="The cannon.">CCannon</a></code>. The three most important cannon tasks are creating it, firing it, and making it explode. Each of these is covered in a separate subsection below.</p>
<p><a class="anchor" id="section5-1-1"></a></p><h3>5.1.1 Creating the Cannon</h3>
<p>The objects, physics bodies, and joints that make up the cannon are created in the <code><a class="el" href="class_c_cannon.html" title="The cannon.">CCannon</a></code> constructor <code><a class="el" href="class_c_cannon.html#a574ad10283380b932ad36c342f890704" title="Constructor.">CCannon::CCannon</a></code>. The cannon consists of four objects, a triangular base, a polygonal barrel, and two wheels (see, for example, <a class="el" href="#fig1">Fig. 1</a>, <a class="el" href="#fig3">Fig. 3</a>, and <a class="el" href="#fig6">Fig. 6</a>). The barrel is attached to the top of the triangular base using a revolute joint. The wheels are attached to the bottom of the base using wheel joints.</p>
<p>The constructor creates the cannon base by calling <code><a class="el" href="class_c_cannon.html#a6e84fcf3a92d95f5b226c7567bf3662b" title="Create a cannon base in Physics World.">CCannon::CreateBase</a></code>, which returns a pointer to the cannon base body in Box2D that the constructor then saves in <code><a class="el" href="class_c_cannon.html#aab3ec7dda955c52da42dc9432b0082e3" title="Pointer to cannon base in Physics World.">CCannon::m_pBase</a></code>. It then calls <code><a class="el" href="class_c_cannon.html#ac9d99b276971a961be0f2ecba3c42edb" title="Create a cannon barrel in Physics World.">CCannon::CreateBarrel</a></code>, which returns a pointer to the cannon barrel body in Box2D that the constructor then saves in <code><a class="el" href="class_c_cannon.html#acc990eadd998909fa1b1d6e29bbcc873" title="Pointer to cannon barrel in Physics World.">CCannon::m_pBarrel</a></code>. Next, it calls <code><a class="el" href="class_c_cannon.html#a7d038475a4063ed61cb18b69ca72d975" title="Create a cannon wheel in Physics World.">CCannon::CreateWheel</a></code> twice, once for each wheel, saving the pointers to the Box2D bodies returned in <code><a class="el" href="class_c_cannon.html#aa7d04923f5950183c5d03370d9bc2d03" title="Pointer to cannon wheel in Physics World.">CCannon::m_pWheel1</a></code> and <code><a class="el" href="class_c_cannon.html#afa6bc116df143ea00c396b9c647cb71e" title="Pointer to cannon wheel in Physics World.">CCannon::m_pWheel2</a></code>.</p>
<p>Each of the functions <code><a class="el" href="class_c_cannon.html#a6e84fcf3a92d95f5b226c7567bf3662b" title="Create a cannon base in Physics World.">CCannon::CreateBase</a></code>, <code><a class="el" href="class_c_cannon.html#ac9d99b276971a961be0f2ecba3c42edb" title="Create a cannon barrel in Physics World.">CCannon::CreateBarrel</a></code>, and <code><a class="el" href="class_c_cannon.html#a7d038475a4063ed61cb18b69ca72d975" title="Create a cannon wheel in Physics World.">CCannon::CreateWheel</a></code> take three parameters, the horizontal and vertical coordinates of the physics bodies in world space, and a collision index. The base and the barrel shapes are <code>b2PolygonShape</code>s, which we have no met before, and the wheel shapes are are of course <code>b2CircleShape</code>s which we have. For example, to create the triangle shape for the base shown in <a class="el" href="#fig6">Fig. 6</a> we declare the following array of vertices, where <code>w2</code> and <code>h2</code> are, respectively, half the width and half the height of the triangle sprite: </p><pre class="fragment">b2Vec2 vertices[3];
vertices[0].Set(-w2, -h2);
vertices[1].Set(w2, -h2);
vertices[2].Set(0.0f, h2);
</pre><p> and we create the <code>b2PolygonShape</code> as follows: </p><pre class="fragment">b2PolygonShape shape;
shape.Set(vertices, 3);
</pre><p> The collision index parameter mentioned above is used to set the <code>fd.filter.groupIndex</code> field the <code>b2FixtureDef</code> in each of <code><a class="el" href="class_c_cannon.html#a6e84fcf3a92d95f5b226c7567bf3662b" title="Create a cannon base in Physics World.">CCannon::CreateBase</a></code>, <code><a class="el" href="class_c_cannon.html#ac9d99b276971a961be0f2ecba3c42edb" title="Create a cannon barrel in Physics World.">CCannon::CreateBarrel</a></code>, and <code><a class="el" href="class_c_cannon.html#a7d038475a4063ed61cb18b69ca72d975" title="Create a cannon wheel in Physics World.">CCannon::CreateWheel</a></code>. You will notice that this is always <code>-42</code> in the constructor code. This ensures that all fixtures attached to Box2D bodies in this program that have this group index (in our case, only the cannon parts) cannot (because of the negative sign) collide with each other. We will revisit this in <a class="el" href="#section5-1-3">Section 5.1.3</a>.</p>
<p>The constructor then creates a wheel joint for each wheel, saving pointers to them in <code><a class="el" href="class_c_cannon.html#a970286e17bdcd557ce9e42cc48e084b9" title="Pointer to cannon wheel joint in Physics World.">CCannon::m_pWheelJoint1</a></code> and <code><a class="el" href="class_c_cannon.html#a970286e17bdcd557ce9e42cc48e084b9" title="Pointer to cannon wheel joint in Physics World.">CCannon::m_pWheelJoint1</a></code>. This process should already be familiar to you from <a href="../box2djoints/index.html#section5-5">the car</a> in the Box2D Joint Toy. Next it creates a revolute joint between the cannon case and barrel. The process of creating a revolute joint should be familiar to you from the and the <a href="../box2djoints/index.html#section5-1">the windmill</a> in the Box2D Joint Toy. However, we want the barrel to be restricted to pointing horizontally to the right or upwards at a maximum angle of \(45^\circ\) as shown in <a class="el" href="#fig7">Fig. 7</a>. This is achieved by setting the hitherto unused <code>lowerAngle</code> field of the instance of <code>b2RevoluteJointDef</code> used to create the revolute joint to <code>-b2_pi/4.0f</code> and the <code>upperAngle</code> field to <code>0.0f</code>, not forgetting to also set <code>enableLimit</code> to <code>true</code> to activate them.</p>
<p><a class="anchor" id="fig7"></a></p><div class="image">
<img src="elevation.png" alt="" width="25%"/>
<div class="caption">
Fig. 7: Minimum (left) and maximum (right) cannon elevation.</div></div>
<p>Lastly, the <code><a class="el" href="class_c_cannon.html" title="The cannon.">CCannon</a></code> constructor creates the objects for the cannon parts with the appropriate sprites and pointers to Box2D bodies.</p>
<p><a class="anchor" id="section5-1-2"></a></p><h3>5.1.2 Firing the Cannon</h3>
<p>To fire a cannonball means creating one a short distance away from the muzzle of the cannon and giving it an impulse in the direction that the muzzle is facing. For example, if the cannon is pointing horizontally to the right, the cannon barrel has width \(w_0\), the cannonball has width \(w_1\), and we wish it to be created a small non-zero distance \(\delta\) in front of the cannon muzzle as shown in <a class="el" href="#fig8">Fig. 8</a>, then the center of the cannonball must be created at horizontal distance \((w_0 + w_1)/2 + \delta\) from the center of the cannon barrel and given a horizontal impulse.</p>
<p><a class="anchor" id="fig8"></a></p><div class="image">
<img src="ballpos1.png" alt="" width="15%"/>
<div class="caption">
Fig. 8: Initial position of cannonball.</div></div>
<p>If the cannon barrel is rotated, then the vector from the center of the cannon barrel to the center of the cannonball must be rotated by the same amount as shown in <a class="el" href="#fig9">Fig. 9</a>. The impulse given to the cannonball must be in the direction of this vector.</p>
<p><a class="anchor" id="fig9"></a></p><div class="image">
<img src="ballpos0.png" alt="" width="50%"/>
<div class="caption">
Fig. 9: Initial position of cannonball with rotation.</div></div>
<p>When the player indicates that they want to fire the cannon by depressing the space bar (see <a class="el" href="#section2">Section 2</a>), <code><a class="el" href="class_c_game.html#a74a75ef02b07f0f785de8aa6e7631b5d" title="The keyboard handler.">CGame::KeyboardHandler</a></code> calls <code><a class="el" href="class_c_cannon.html#a7694d324e7716dcab02e0d21c02a3f2a" title="Fire the cannon.">CCannon::Fire</a></code>, which uses an instance of <code>b2BodyDef</code> to create a body for the cannonball object as follows: </p><pre class="fragment">b2BodyDef bd;
bd.type = b2_dynamicBody;
b2Vec2 v = m_pBarrel-&gt;GetPosition() +
  b2Mul(b2Rot(m_pBarrel-&gt;GetAngle()), b2Vec2(RW2PW(w + 4), 0.0f)); 
bd.position.Set(v.x, v.y);
</pre><p> Here, <code>b2Vec2(RW2PW(w + 4), 0.0f)</code> is the horizontal vector from the center of the barrel to the center of the cannonball, where <code>w</code> is half the width of the barrel plus half the width of the cannonball and \(\delta\) is \(4\) in <a class="el" href="#fig8">Fig.8</a>. Then,</p>
<p>b2Rot(m_pBarrel-&gt;GetAngle()), b2Vec2(RW2PW(w + 4), 0.0f)</p>
<p>describes the rotation of this vector by the barrel's angle which is obtained by calling <code>m_pBarrel-&gt;GetAngle())</code>. The call to <code>b2Mul</code> applies that rotation to that vector, which is added to the cannon barrel's position obtained by calling <code>m_pBarrel-&gt;GetPosition()</code> to give the initial position of the cannonball in Physics World which is stored temporarily in local variable <code>v</code> and used to set the cannonball body's initial position by calling <code>bd.position.Set(v.x, v.y)</code>.</p>
<p>The impulse to the cannonball from the launch is applied to the cannonball body using <code>b2Body::ApplyLinearImpulse</code>, and an impulse in the opposite direction is applied to the cannon barrel to make the cannon recoil.</p>
<p><a class="anchor" id="section5-1-3"></a></p><h3>5.1.3 Exploding the Cannon</h3>
<p>As mentioned in <a class="el" href="#section4">Section 4</a>, we need to make the cannon explode in interesting ways. This is achieved by breaking the joints between the bodies that make up the cannon and giving them random impulses so that they fly across the screen as shown in <a class="el" href="#fig3">Fig. 3</a>. This is implemented in <code><a class="el" href="class_c_cannon.html#ab60ba1a492265b1318103ad995e059f5" title="Make cannon explode.">CCannon::Explode</a></code>, which first makes the cannon bodies able to collide with each other by calling <code><a class="el" href="class_c_cannon.html#ad15a3450e6e166e512e3d17317d4237d" title="Make cannon parts collide-able in Physics World.">CCannon::MakeCollide</a></code> for each body, which sets the group index for every fixture attached to the body (in principle there may be more that one) to zero. Supper <code>b</code> points to an instance of <code>b2Body</code>. Then, </p><pre class="fragment">b2Filter f = b-&gt;GetFixtureList()-&gt;GetFilterData();
</pre><p> gets <code>b</code>'s collision filter data into <code>f</code>, </p><pre class="fragment">f.groupIndex = 0;
</pre><p> sets its group index to <code>0</code> so that it can collide with all other fixtures with group index <code>0</code> (i.e. those attached to cannon bodies), and </p><pre class="fragment">b-&gt;GetFixtureList()-&gt;SetFilterData(f);
</pre><p> loads the updated filter data from <code>f</code> back into the body pointed to by <code>b</code>. The joints are destroyed by calling </p><pre class="fragment">m_pPhysicsWorld-&gt;DestroyJoint(m_pWheelJoint1);
m_pPhysicsWorld-&gt;DestroyJoint(m_pWheelJoint2);
m_pPhysicsWorld-&gt;DestroyJoint(m_pBarrelJoint);
</pre><p> and impulses are applied to the cannon bodies using <code>b2Body::ApplyLinearImpulse</code> much in the same way as impulses were applied to the cannonball and cannon barrel above.</p>
<p><a class="anchor" id="section5-2"></a></p><h2>5.2 Collision Sounds</h2>
<p>The sounds made by objects colliding in this game are totally kluged. We will see a better way of doing this in the <a href="../cannonstars/index.html">Box2D Cannon Game With Stars</a>. In the current game <code><a class="el" href="class_c_object.html#a892cb35d1b86abb11dca6c5a4744a179" title="Make collision sound, if appropriate.">CObject::MakeCollisionSound</a></code> is called once per object per animation frame. This function gets the object's current velocity by calling its body's <code>GetLinearVelocityFromWorldPoint(b2Vec2(0, 0))</code> function and comparing it to its velocity in the previous frame which was stored in <code><a class="el" href="class_c_object.html#aa6aa837c893d2afb8f510d88fa456eab" title="Old velocity vector, needed to infer collisions.">CObject::m_b2vOldV</a></code>. If the difference between these vectors has "large enough" magnitude, then a collision sound is played. Currently the cannon barrel makes a clang when colliding with anything and everything else makes a thump when colliding with anything. Finer control over which objects make what sounds when colliding with which objects is possible here but we will put it off until the <a href="../cannonstars/index.html">Box2D Cannon Game With Stars</a>.</p>
<p><a class="anchor" id="section6"></a></p><h1>6. What Next?</h1>
<p>Next, take a look at the <a href="../cannonstars/index.html">Box2D Cannon Game With Stars</a>. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
