<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Box2D Bouncy Things Toy: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="sagedoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">Box2D Bouncy Things Toy
   </div>
   <div id="projectbrief">Game Physics with a 2D Physics Engine</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="contents">
<div class="textblock"><p><a class="anchor" id="section1"></a></p><h1>1. Introduction</h1>
<p>This is a simple toy that lets you see how easy it is to get started with Box2D. It does not have sound, so don't worry when you don't hear any. The next few code demos after this one will drill down into Box2D more deeply, so don't be concerned if you don't fully understand all of the code here. We do however recommend that you briefly examine the Box2D manual (which should be in the folder in which you installed Box2D from GitHub) before reading the code and documentation for this toy. <a class="el" href="#fig1">Fig. 1</a> shows a screen shot with some balls and boxes bouncing around inside the window.</p>
<p><a class="anchor" id="fig1"></a></p><div class="image">
<img src="screenshot.png" alt="" width="60%"/>
<div class="caption">
Fig. 1: Screen shot.</div></div>
<p>The remainder of this page is divided into five sections. <a class="el" href="#section2">Section 2</a> lists the controls and their corresponding actions, <a class="el" href="#section3">Section 3</a> tells you how to build it, <a class="el" href="#section4">Section 4</a> gives you a list of actions to take in the game to see some of its important features, <a class="el" href="#section5">Section 5</a> gives a breakdown of the code, and <a class="el" href="#section6">Section 6</a> addresses the question "what next?".</p>
<p><a class="anchor" id="section2"></a></p><h1>2. Keyboard Controls</h1>
<center> <table class="doxtable">
<tr>
<td><center><b>Key</b></center> </td><td><center><b>Action</b></center> </td></tr>
<tr>
<td><center>F1</center> </td><td>Help (this document) </td></tr>
<tr>
<td><center>F2</center> </td><td>Toggle draw mode from "sprites only", to "sprites and lines", to "lines only" </td></tr>
<tr>
<td><center>Backspace</center> </td><td>Reset </td></tr>
<tr>
<td><center>Space</center> </td><td>Drop stuff </td></tr>
<tr>
<td><center>PrtScr (hold down)</center> </td><td>Save screenshot to a PNG file </td></tr>
<tr>
<td><center>Esc</center> </td><td>Quit game and close the window </td></tr>
</table>
</center><p><a class="anchor" id="section3"></a></p><h1>3. Building the Game</h1>
<p>This code uses <a href="../sage/index.html">SAGE</a> and <a href="https://github.com/erincatto/Box2D">Box2D</a>. Make sure that you have followed the <a href="../install/index.html">SAGE Installation Instructions</a> and the <a href="../installphysics/index.html">Box2D Installation Instructions</a>. Navigate to the folder <span style="background-color:#D8E4D8;"><code>7. Box2D Bouncy Things Toy</code></span> in your copy of the <span style="background-color:#D8E4D8;"><code>sage-physics</code></span> repository. Run <span style="background-color:#D8E4D8;"><code>checkenv.bat</code></span> to verify that you have set the environment variables correctly. Open <span style="background-color:#D8E4D8;"><code>Bouncy Things Toy.sln</code></span> with Visual Studio and build the Release configuration. Alternatively, run <span style="background-color:#D8E4D8;"><code>Build.bat</code></span> to build both Release and Debug configurations.</p>
<p><a class="anchor" id="section4"></a></p><h1>4. Game Play</h1>
<p>For a full list of keyboard commands see <a class="el" href="#section2">Section 2</a>. The space bar drops a collection of balls and boxes that you can watch fall to the bottom of the screen and bounce around in a most satisfactory manner. Notice that they are created outside the window and enter from above, and that they may overlap at first before squeezing out. This is happily provided by Box2D without and need for code on our part. You can do this repeatedly or even hold the space bar down until the window is approximately full, at which time no further objects will be created. The <code>Backspace</code> key will delete all objects. Using the <code>F2</code> key you can toggle between drawing sprites (<a class="el" href="#fig1">Fig. 1</a>), sprites and shape outlines (<a class="el" href="#fig2">Fig. 2</a>, left), and shapes only (<a class="el" href="#fig2">Fig. 2</a>, right). Adding a line drawing option to the code lets us ensure that the collision shapes in Box2D line up properly with the outlines of the sprites.</p>
<p><a class="anchor" id="fig2"></a></p><div class="image">
<img src="screenshot2.png" alt="" width="90%"/>
<div class="caption">
Fig. 2: Screen shots with sprites and shapes (left), and shapes only (right).</div></div>
<p><a class="anchor" id="section5"></a></p><h1>5. Code Breakdown</h1>
<p>There are three important things to notice in this code, and each is covered in a separate section below. <a class="el" href="#section5-1">Section 5.1</a> introduces the concepts of <em>Physics World</em> and <em>Render World</em>, the importance of keeping their scales different, and the method we use to ensure that scaling in the code is readable and maintainable. <a class="el" href="#section5-2">Section 5.2</a> shows you where and how Physics World is created in the code, and a function that must be called once per frame to maintain it. <a class="el" href="#section5-3">Section 5.3</a> shows you how the code manages game objects with their Render World sprites and their Physics World bodies.</p>
<p><a class="anchor" id="section5-1"></a></p><h2>5.1 Render World and Physics World</h2>
<p>Lets define <em>Render World</em> to be the world that you see in <a class="el" href="#fig1">Fig. 1</a>, made up of sprites and images, with units measured in pixels. <em>Physics World</em> is the world inside the physics engine, made up of floating point number and vectors, with its own units. The Box2D manual makes it clear that Physics World units should <em>not</em> be pixels, otherwise the stability of the equation solver may be called into doubt. (What equation solver you may ask? Remember the <a href="../ballandspring/index.html">Ball and Spring Toy</a>.) We choose to scale from Render World to Physics World by dividing by a factor of 10, which is set by changing the value of <code>fPRV</code> in <span style="background-color:#D8E4D8;"><code><a class="el" href="_game_defines_8h.html" title="Game specific defines and enumerated types.">GameDefines.h</a></code></span>. </p><pre class="fragment">const float fPRV = 10.0f;
</pre><p><span style="background-color:#D8E4D8;"><code><a class="el" href="_game_defines_8h.html" title="Game specific defines and enumerated types.">GameDefines.h</a></code></span> also has some useful functions <code>PW2RW</code> to convert Physics World measurements to Render World for various types, for example, </p><pre class="fragment">inline float PW2RW(float x){return x*fPRV;};
</pre><p>functions <code>RW2PW</code> to convert Render World measurements to Physics World for various types, for example, </p><pre class="fragment">inline float RW2PW(float x){return x/fPRV;};
</pre><p>What can possibly go wrong? Your physics code might actually work perfectly even if you ignore this advice. That's probably because it is simple code without much interaction. But as your game or toy becomes more and more complicated you may find that Box2D becomes unstable. This is a property of all physics engines, not just Box2D. What do I mean by unstable? Lets just say that things will start to look weird. For example, you may have a bouncing cannonball as shown in <a class="el" href="#fig3">Fig. 3</a>. The one shown in <a class="el" href="#fig3">Fig. 3</a> has a perfectly elastic bounce, but yours may not. You want it to eventually stop bouncing and come to rest, but it never completely does, instead it continues twitching as shown in <a class="el" href="#fig4">Fig. 4</a>. That's just one example of the weird behavior that you will see if you don't rescale your Physics units.</p>
<p><a class="anchor" id="fig3"></a></p><div class="image">
<img src="image14.gif" alt=""/>
<div class="caption">
Fig. 3: A bouncing cannonball.</div></div>
<p><a class="anchor" id="fig4"></a></p><div class="image">
<img src="image15.gif" alt=""/>
<div class="caption">
Fig. 4: An unstable cannonball that should be still.</div></div>
<p><a class="anchor" id="section5-2"></a></p><h2>5.2 Creating and Maintaining Physics World</h2>
<p>Physics World is created in <code><a class="el" href="class_c_game.html#a4349adf43d0dc02d80ad06ca1d77411c" title="Initialize the game.">CGame::Initialize</a></code> and is accessible through a pointer <code><a class="el" href="class_c_common.html#a3e867eb301b34599b66099460254a302" title="Pointer to Box2D Physics World.">CCommon::m_pPhysicsWorld</a></code>. When creating the Box2D Physics World you need to specify the gravity as a parameter. There is nothing special about choosing the number 100 in the line of code below - it was chosen by experimenting until it "looked right". </p><pre class="fragment">m_pPhysicsWorld = new b2World(RW2PW(0, -100));
</pre><p>Physics World gets updated once per frame in <code><a class="el" href="class_c_game.html#aec83638cb2fdd94ef098132eb59617d8" title="Process an animation frame.">CGame::ProcessFrame</a></code>. The three parameters are the frame time, the number of move iterations, and the number of collision detection and response iterations. The latter two parameters are somewhat arbitrarily chosen defaults. </p><pre class="fragment">m_pPhysicsWorld-&gt;Step(m_pTimer-&gt;GetFrameTime(), 4, 2);
</pre><p><a class="anchor" id="section5-3"></a></p><h2>5.3 Objects and Physics Bodies</h2>
<p>Game objects are represented by an object class <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code>, which is managed by class <code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code>. <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> keeps a pointer to the Box2D body associated with the object. </p><pre class="fragment">b2Body* m_pBody = nullptr;
</pre><p><code>CObject::b2Body</code> is initialized by the <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> constructor <code><a class="el" href="class_c_object.html#ab353b95461709bffbf5ff4de337e9b6f" title="Constructor.">CObject::CObject</a></code> as follows: </p><pre class="fragment">CObject(eSprite, b2Body*);
</pre><p>This puts the onus on the code creating the object to first construct its body. This is the subject of <a class="el" href="#section5-3-1">Section 5.3.1</a>. <a class="el" href="#section5-3-2">Section 5.3.2</a> shows the proper way of deleting physics bodies (no, you don't just <code>delete</code> them). <a class="el" href="#section5-3-3">Section 5.3.3</a> shows how to interrogate physics bodies so that their sprites can be drawn in the correct position and orientation.</p>
<p><a class="anchor" id="section5-3-1"></a></p><h2>5.3.1 Creating Physics Bodies</h2>
<p><code><a class="el" href="class_c_object_manager.html#a6f1c59cb864e7d520447a67e78603381" title="Create a crate.">CObjectManager::CreateCrate</a></code> and <code><a class="el" href="class_c_object_manager.html#a702edb152f20a3c2a975a5395e188c37" title="Create a ball.">CObjectManager::CreateBall</a></code> are called from <code><a class="el" href="class_c_game.html#a6a5af1b87c696a23a626812b74c653ea" title="Create game objects.">CGame::CreateObjects</a></code> to create the crates and balls as seen in <a class="el" href="#fig1">Fig. 1</a>. <code><a class="el" href="class_c_game.html#a6a5af1b87c696a23a626812b74c653ea" title="Create game objects.">CGame::CreateObjects</a></code> is called from <code><a class="el" href="class_c_game.html#a74a75ef02b07f0f785de8aa6e7631b5d" title="The keyboard handler.">CGame::KeyboardHandler</a></code> in response to the <code>VK_SPACE</code> key.</p>
<p><code><a class="el" href="class_c_object_manager.html#a6f1c59cb864e7d520447a67e78603381" title="Create a crate.">CObjectManager::CreateCrate</a></code> takes two parameters <code>x</code> and <code>y</code>, which are the coordinates of the center of the object in Physics World coordinates. It first creates a Box2D body definition <code>bd</code> and sets its <code>type</code> field to <code>b2_dynamicBody</code> and its position to <code>[x, y]</code>. </p><pre class="fragment">b2BodyDef bd; 
bd.type = b2_dynamicBody;
bd.position.Set(x, y);
</pre><p>Then it gets the width <code>w</code> and height <code>h</code> of the crate in Render World by calling <code>Sage::CSpriteRenderer::GetSize</code> on the sprite type <code>eSprite::Crate</code>. </p><pre class="fragment">float w, h;
m_pRenderer-&gt;GetSize(eSprite::Crate, w, h);
</pre><p>Next we create a Box2D <em>shape</em> for the crate. A rectangle in Box2D is a special instance of <code>b2PolygonShape</code>, which handily has a special function for creating a rectangle shape called <code>b2PolygonShape::SetAsBox</code>. This takes as parameters the <em>half width</em> and <em>half height</em> of a rectangle. According to the Box2D manual this is to make it consistent with Box2D circle shapes which are created using the circle's radius (i.e. half width). I always seem to forget this so that the rectangles drawn in sprite and line mode do not align as shown in <a class="el" href="#fig5">Fig. 5</a>. Compare this with the correct version in <a class="el" href="#fig2">Fig. 2</a> (left). </p><pre class="fragment">b2PolygonShape s;
s.SetAsBox(RW2PW(w - 2.0f)/2.0f, RW2PW(h - 2.0f)/2.0f);
</pre><p><a class="anchor" id="fig5"></a></p><div class="image">
<img src="bigbox.png" alt="" width="50%"/>
<div class="caption">
Fig. 5: Physics World boxes when you forget to use half widths and half height.</div></div>
<p>Note that we have subtracted two pixels from the Render World width and height before converting to Physics World units. This is because Box2D keeps a narrow border area around each shape to keep it away from other shapes. The sprite therefore needs to be a couple of pixels wider and taller than the shape. For example, <a class="el" href="#fig6">Fig. 6</a> (left) shows the tiny gaps around a box created with </p><pre class="fragment">s.SetAsBox(RW2PW(w)/2.0f, RW2PW(h)/2.0f);
</pre><p>and <a class="el" href="#fig6">Fig. 6</a> (right) shows the smaller or non-existent gap around a box created with the correct parameters. </p><pre class="fragment">s.SetAsBox(RW2PW(w - 2.0f)/2.0f, RW2PW(h - 2.0f)/2.0f);
</pre><p><a class="anchor" id="fig6"></a></p><div class="image">
<img src="gap.png" alt=""/>
<div class="caption">
Fig. 6: Physics World boxes without (left) and with (right) a 2 pixel size decrease.</div></div>
<p>Next we need a Box2D <em>fixture</em> which is used to attach a Box2D shape to a Box2D body. We declare a Box2D fixture definition <code>b2FixtureDef</code> called <code>fd</code> and set its <code>shape</code> field to be a pointer to the box shape <code>s</code> created above, its <code>density</code> field to <code>1.0f</code> and its <code>restitution</code> field <code>restitution</code> to <code>0.3f</code>. The restitution is a measure of how bouncy a fixture is. Setting it to <code>1.0f</code> means a perfectly elastic collision. The value <code>0.3f</code> was chosen by playing with it until it looked right. </p><pre class="fragment">b2FixtureDef fd;
fd.shape = &amp;s;
fd.density = 1.0f;
fd.restitution = 0.3f;
</pre><p>Next we ask Box2D to create a body using the body definition <code>bd</code> by calling <code>b2World::CreateBody</code> which returns a pointer to the <code>b2Body</code> created. We save this in a local variable <code>pCrate</code>. </p><pre class="fragment">b2Body* pCrate = m_pPhysicsWorld-&gt;CreateBody(&amp;bd);
</pre><p>Next we add a fixture to the body using the fixture definition <code>fd</code> created above. </p><pre class="fragment">pCrate-&gt;CreateFixture(&amp;fd);
</pre><p>Finally we create an instance of <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> and append it at the end of the object manager's object list <code><a class="el" href="class_c_object_manager.html#aebad6730d157c0f48a8e06a26a61640f" title="Object list.">CObjectManager::m_stdList</a></code>. Notice that the body definition, shape, and fixture definitions are all variables local to <code><a class="el" href="class_c_object_manager.html#a6f1c59cb864e7d520447a67e78603381" title="Create a crate.">CObjectManager::CreateCrate</a></code>. There is no need to save them. All we need is a pointer to the <code>b2Body</code>. </p><pre class="fragment">m_stdList.push_back(new CObject(eSprite::Crate, pCrate));
</pre><p><code><a class="el" href="class_c_object_manager.html#a702edb152f20a3c2a975a5395e188c37" title="Create a ball.">CObjectManager::CreateBall</a></code> is similar except that is uses an instance of <code>b2CircleShape</code> instead of <code>b2PolygonShape</code>. </p><pre class="fragment">b2CircleShape s;
s.m_radius = RW2PW(m_pRenderer-&gt;GetWidth(eSprite::Ball)/2.0f);
</pre><p><code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code> also has a function <code><a class="el" href="class_c_object_manager.html#a9cd9848b67155361f36449fb69d3b98e" title="Create the edges of the world.">CObjectManager::CreateWorldEdges</a></code> to create edges at the left, right, and bottom of the window, the first two of which extend above the window in order to catch objects that bounce above the top of the window. It too is similar to the above but uses three instances of <code>b2EdgeShape</code>, one each for the left, right, and bottom of the window.</p>
<p><a class="anchor" id="section5-3-2"></a></p><h2>5.3.2 Destroying Physics Bodies</h2>
<p>Physics bodies are destroyed in the <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> destructor <code><a class="el" href="class_c_object.html#a93a3c3bc7d9a6462ef00e25404d9b0eb" title="Destructor.">CObject::~CObject</a></code>: </p><pre class="fragment">m_pPhysicsWorld-&gt;DestroyBody(m_pBody);
</pre><p>This is called from <code><a class="el" href="class_c_object_manager.html#a5f13656ff4050c227c8f1fb27803d116" title="Reset to initial conditions.">CObjectManager::Clear</a></code> and the <code><a class="el" href="class_c_object_manager.html" title="The object manager.">CObjectManager</a></code> destructor <code><a class="el" href="class_c_object_manager.html#a7f985240f67c8bf03a26f370e67fdb33" title="Destructor.">CObjectManager::~CObjectManager</a></code>.</p>
<p><a class="anchor" id="section5-3-3"></a></p><h2>5.3.3 Object Drawing Using Physics Bodies</h2>
<p>When not using a physics engine <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code> would normally have a position variable <code>Vector2 m_vPos</code> and an orientation variable <code>float m_fRoll</code> and would be drawn using a call to <code>Sage::CSpriteRenderer::Draw</code> such as </p><pre class="fragment">m_pRenderer-&gt;Draw(m_eSpriteType, m_vPos, m_fRoll);
</pre><p>Instead, <code><a class="el" href="class_c_object.html#ae060ffb1aa3bf6148614cf6506074e42" title="Draw object.">CObject::Draw</a></code> uses <code>b2Body::GetPosition</code> to get the position from Box2D and <code>b2Body::GetAngle</code> to get the orientation: </p><pre class="fragment">const float a = m_pBody-&gt;GetAngle(); 
const b2Vec2 v = m_pBody-&gt;GetPosition();
m_pRenderer-&gt;Draw(m_eSpriteType, PW2RW(v), a);
</pre><p>Notice the use of <code>PW2RW</code> to convert Physics World units to Render World units (see <a class="el" href="#section5-1">Section 5.1</a>).</p>
<p><a class="anchor" id="section6"></a></p><h1>6. What Next?</h1>
<p>Next, take a look at the <a href="../box2djoints/index.html">Box2D Joint Toy</a>. You may want to examine what the Box2D manual (which should be in the folder in which you installed Box2D from GitHub) says about the functions and structures used in this toy before you do this. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
