<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ball and Spring Toy: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="sagedoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Ball and Spring Toy
   </div>
   <div id="projectbrief">Game Physics with Bespoke Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="contents">
<div class="textblock"><p><a class="anchor" id="section1"></a></p><h1>1. Introduction</h1>
<p><a class="anchor" id="fig1"></a></p><div class="image">
<img src="all.gif" alt=""/>
<div class="caption">
Fig. 1: Bodies made up from springs and sticks.</div></div>
<p>The Ball and Spring Toy applies Verlet integration and Gauss-Seidel Relaxation to bodies made up of balls connected by springs and sticks. The bodies fall under gravity and you can apply a random impulse to them to see how they react The types of bodies available are chains of length 2, 3, and 4; wheels of size 4, 5, and 6; and a ragdoll robot (see <a class="el" href="#fig1">Fig. 1</a>). For each body type except the ragdoll robot you are given two bodies, one with springs and one with sticks. The ragdoll robot has some primitive AI that attempts to make it stand up and move to the center of the window.</p>
<p>The remainder of this page is divided into five sections. <a class="el" href="#section2">Section 2</a> lists the controls and their corresponding actions, <a class="el" href="#section3">Section 3</a> tells you how to build it, <a class="el" href="#section4">Section 4</a> gives you a list of actions to take in the game to see some of its important features, <a class="el" href="#section5">Section 5</a> gives a breakdown of the code, and <a class="el" href="#section6">Section 6</a> addresses the question "what next?".</p>
<p><a class="anchor" id="section2"></a></p><h1>2. Controls</h1>
<center> <table class="doxtable">
<tr>
<td><center><b>Key</b></center> </td><td><center><b>Action</b></center> </td></tr>
<tr>
<td><center>F1</center> </td><td>Help (this document) </td></tr>
<tr>
<td><center>Backspace</center> </td><td>Restart with the current body type </td></tr>
<tr>
<td><center>Enter</center> </td><td>Advance to the next body type </td></tr>
<tr>
<td><center>Space</center> </td><td>Apply a random impulse </td></tr>
<tr>
<td><center>PrtScr (hold down)</center> </td><td>Save screenshot to a PNG file </td></tr>
<tr>
<td><center>Esc</center> </td><td>Quit game and close the window </td></tr>
</table>
</center><p><a class="anchor" id="section3"></a></p><h1>3. Building the Game</h1>
<p>This code uses <a href="../sage/index.html">SAGE</a>. Make sure that you have followed the <a href="../install/index.html">SAGE Installation Instructions</a>. Navigate to the folder <span style="background-color:#D8E4D8;"><code>5. Ball and Spring Toy</code></span> in your copy of the <span style="background-color:#D8E4D8;"><code>sage-physics</code></span> repository. Run <span style="background-color:#D8E4D8;"><code>checkenv.bat</code></span> to verify that you have set the environment variables correctly. Open <span style="background-color:#D8E4D8;"><code>Ball and Spring Toy.sln</code></span> with Visual Studio and build the Release configuration. The Release executable file <span style="background-color:#D8E4D8;"><code>Ball and Spring Toy.exe</code></span> will appear. Alternatively, run <span style="background-color:#D8E4D8;"><code>Build.bat</code></span> to build both Release and Debug configurations.</p>
<p><a class="anchor" id="section4"></a></p><h1>4. Game Play</h1>
<p>As described in <a class="el" href="#section2">Section 2</a>, use the keyboard to select various bodies and watch how they respond to random impulses. Note that the bodies made from springs will deform when they hit the edges of the window but the bodies made from wood will not (see <a class="el" href="#fig2">Fig. 2</a> for an example). If you apply an impulse to the ragdoll robot and let it lie on the bottom of the window for a second or two as shown in <a class="el" href="#fig3">Fig. 3</a>, then it will attempt to self-right and move to the center of the window by applying impulses to parts of its body.</p>
<p><a class="anchor" id="fig2"></a></p><div class="image">
<img src="deform.png" alt="" width="50%"/>
<div class="caption">
Fig. 2: Deformation of bodies with springs.</div></div>
<p><a class="anchor" id="fig3"></a></p><div class="image">
<img src="robot.png" alt="" width="50%"/>
<div class="caption">
Fig. 3: The robot at rest.</div></div>
<p><a class="anchor" id="section5"></a></p><h1>5. Code Breakdown</h1>
<p>The most important parts of this code are Verlet integration (<a class="el" href="#section5-1">Section 5.1</a>), Jacobi-Gauss-Seidel relaxation (<a class="el" href="#section5-2">Section 5.2</a>), and bodies made up of points, sticks, and springs (<a class="el" href="#section5-3">Section 5.3</a>).</p>
<p><a class="anchor" id="section5-1"></a></p><h2>5.1 Verlet Integration</h2>
<p>Loup Verlet developed the concept that is now called <em>Verlet integration</em> for use in particle physics simulation. There are mathematical reasons for using Verlet integration instead of Euler integration when simulating systems of particles. One useful feature of Verlet integration is that it is easy to incorporate constraints, which means that Verlet integration makes it easier to code soft-body animation.</p>
<p>Let \(\vec{s}_i\) be the position of a point at the end of frame \(i\), \(\vec{v}_i\) its velocity, and \(\vec{a}_i\) its acceleration, and \(t_i\) be the fixed frame duration. Suppose we know \(\vec{a}_i\), \(\vec{s}_i\), \(\vec{s}_{i-1}\) and want to compute \(\vec{s}_{i+1}\). Let \(\delta_i = \vec{s}_i - \vec{s}_{i-1}\), the distance moved in frame \(i\). The distance to be moved in frame \(i+1\) is </p><p class="formulaDsp">
\[\delta_{i+1} = \vec{v}_i t_i + \vec{a}_i t_i^2/2.\]
</p>
<p> Now, \(\delta_i\) is a good approximation to \(\vec{v}_i t_i\), and therefore  </p><p class="formulaDsp">
\[
\delta_{i+1} = \delta_i + \vec{a}_i t_i^2/2.
\]
</p>
<p> Since \(\vec{s}_{1+1} = \vec{s}_i + \delta_{i+1}\), substituting for \(\delta_{i+1}\),  </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = \vec{s}_i +\delta_i + \vec{a}_i t_i^2/2.
\]
</p>
<p> Substituting for \(\delta_i\), we get  </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = \vec{s}_i + (\vec{s}_i - \vec{s}_{i-1}) + \vec{a}_i t_i^2/2,
\]
</p>
<p> that is, <a class="anchor" id="equation1"></a> </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = 2\vec{s}_i - \vec{s}_{i-1} + \vec{a}_i t_i^2/2.
\tag{1}
\]
</p>
<p> This shows us how to compute \(\vec{s}_{i+1}\) given \(\vec{a}_i\), \(\vec{s}_i\), and \(\vec{s}_{i-1}\). Notice that there is no need to store velocity. We can even fake a kind of friction in the \(Z\) direction using  </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = 1.99\vec{s}_i - 0.99\vec{s}_{i-1} + \vec{a}_i t_i^2/2.
\]
</p>
<p>Recall that in the <a href="../shapes/index.html">Shapes Library</a>, the class <a href="../shapes/class_shapes_1_1_c_dynamic_circle.html">CDynamicCircle</a> has a private member variable <code>m_vVec</code> that stores its velocity vector \(\vec{v}_i\) in frame \(i+1\). This is used in its <a href="../shapes/class_shapes_1_1_c_dynamic_circle.html#ae637ccb409188baa680df552ff20051b"><code>move</code></a> function to compute its new position using the equation <a class="anchor" id="equation2"></a> </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = \vec{s}_i + t_i\vec{v}_i.
\tag{2}
\]
</p>
<p> This method is commonly referred to as <em>Euler integration</em>. Contrast this with <a class="el" href="#equation1">Equation (1)</a> above for Verlet integration. <a class="el" href="#fig4">Fig 4.</a> summarizes the differences between Verlet and Euler integration.</p>
<p><a class="anchor" id="fig4"></a></p><div class="image">
<img src="verlet.png" alt="" width="55%"/>
<div class="caption">
Fig. 4: Verlet integration.</div></div>
<p>We can optimize <a class="el" href="#equation1">Equation (1)</a> by assuming that \(t_i\) is a constant (in fact we can make it equal to \(1\)), ignoring the division by 2 and increasing \(\vec{a}_i\) to compensate, ending up with  </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = 2\vec{s}_i - \vec{s}_{i-1} + \vec{a}_i,
\]
</p>
<p> or, if there is no acceleration, <a class="anchor" id="equation3"></a> </p><p class="formulaDsp">
\[
\vec{s}_{i+1} = 2\vec{s}_i - \vec{s}_{i-1}.
\tag{3}
\]
</p>
<p>We implement this in class <code><a class="el" href="class_c_point.html" title="The point.">CPoint</a></code> which has two private member variables <code><a class="el" href="class_c_point.html#aa6bd2afc43e0fb7aff6c09cc867f2b59" title="Current position.">CPoint::m_vPos</a></code> and <code><a class="el" href="class_c_point.html#a970726d8fff843c2f77f7db6f6dfa0f5" title="Previous position, needed for Verlet.">CPoint::m_vOldPos</a></code>. <code><a class="el" href="class_c_point.html#a0fc7702172f5577d1ffc8376f6cefed6" title="Change position depending on time and velocity.">CPoint::move</a></code> computes the new value of <code><a class="el" href="class_c_point.html#aa6bd2afc43e0fb7aff6c09cc867f2b59" title="Current position.">CPoint::m_vPos</a></code> as follows: </p><pre class="fragment">const Vector2 vTemp = m_vPos;
m_vPos += m_vPos - m_vOldPos; 
m_vOldPos = vTemp;
</pre><p> Notice that the second line of the above code implements <a class="el" href="#equation3">Equation (3)</a>. It uses only four floating point additions, whereas <a class="el" href="#equation2">Equation (2)</a> requires four floating point additions and two floating point multiplications. Acceleration due to gravity is then faked by: </p><pre class="fragment">m_vPos.y -= 0.2f;
</pre><p> <a class="anchor" id="section5-2"></a></p><h2>5.2 Jacobi-Gauss-Seidel Relaxation</h2>
<p>We mentioned in the previous section that Verlet integration makes it easy to enforce constraints on points. We can model a stick by applying Verlet integration to two points at its ends. The constraint is that the distance between the points must remain constant. We can move the stick by moving each point independently, then trying to correct their positions to satisfy the distance constraint (before rendering) if they are the wrong distance apart.</p>
<p><a class="anchor" id="fig5"></a></p><div class="image">
<img src="stick0.png" alt="" width="20%"/>
<div class="caption">
Fig. 5: A stick represented by two points.</div></div>
<p><a class="anchor" id="fig6"></a></p><div class="image">
<img src="stick1.png" alt="" width="20%"/>
<div class="caption">
Fig. 6: The vector from one point to the other.</div></div>
<p>Suppose we have a stick of length \(d\) whose end points are at positions \(\vec{p}_0\) and \(\vec{p}_1\) after they have been moved independently as shown in <a class="el" href="#fig5">Fig. 5</a>. Let \(\vec{v} = \vec{p}_0 - \vec{p}_1\) be the vector from \(\vec{p}_1\) to \(\vec{p}_0\) as shown in <a class="el" href="#fig6">Fig. 6</a> and let us suppose that \(\Vert \vec{v} \Vert \not= d\). We will displace the end points along the stick by an equal amount so that the distance between them is \(d\).</p>
<p><a class="anchor" id="fig7"></a></p><div class="image">
<img src="stick2.png" alt="" width="20%"/>
<div class="caption">
Fig. 7: Correcting the length of the stick.</div></div>
<p>Define <a class="anchor" id="equation4"></a> </p><p class="formulaDsp">
\[
c = 1 - d/\Vert\vec{v}\Vert
\tag{4}
\]
</p>
<p>. Let the new end points of the stick be \(\vec{s}_0 = \vec{p}_0 - c\vec{v}/2\) and \(\vec{s}_1 = \vec{p}_1 + c\vec{v}/2\) as shown in <a class="el" href="#fig6">Fig. 6</a>. The length of this stick is then \(\Vert\vec{s}_0 - \vec{s}_1\Vert = \Vert\vec{v}\Vert -(1-d/\Vert\vec{v}\Vert)\Vert\vec{v}\Vert = d\). This process is called <em>relaxation</em>.</p>
<p><a class="anchor" id="fig8"></a></p><div class="image">
<img src="2stick0.png" alt="" width="45%"/>
<div class="caption">
Fig. 8: Two joined sticks with three points.</div></div>
<p>Now suppose that we have two sticks with one end point in common such that they can freely rotate about this point. Suppose one stick has end points \(p_0\) and \(p_1\), and the other stick has end points \(p_1\) and \(p_2\) as shown in <a class="el" href="#fig8">Fig. 8</a>, left. Further suppose that both sticks have the wrong length and need to be corrected as shown in <a class="el" href="#fig8">Fig. 8</a>, right. We could try relaxing one stick and then the other, but the result will be wrong as shown in <a class="el" href="#fig9">Fig. 9</a>. The shared point \(\vec{p}_1\) will be first moved to the green point in <a class="el" href="#fig9">Fig. 9</a>, left, then to the purple point in <a class="el" href="#fig9">Fig. 9</a>, right. As we see in in <a class="el" href="#fig9">Fig. 9</a> right, the purple point is not on the stick with end points \(p_1\) and \(p_2\).</p>
<p><a class="anchor" id="fig9"></a></p><div class="image">
<img src="2stick1.png" alt="" width="45%"/>
<div class="caption">
Fig. 9: Sequential relaxation gives the wrong result.</div></div>
<p>However, if we repeatedly relax first one stick then the other, the end points will eventually get very close to where they need to be. This was independently discovered by the mathematicians <a href="https://en.wikipedia.org/wiki/Carl_Gustav_Jacob_Jacobi">Jacobi</a>, <a href="https://en.wikipedia.org/wiki/Carl_Friedrich_Gauss">Gauss</a>, and <a href="https://en.wikipedia.org/wiki/Philipp_Ludwig_von_Seidel">Seidel</a>, thus the name <em>Jacobi-Gauss-Seidel</em> relaxation_. Rather than checking for closeness (which would be computationally very expensive), we will just do a small fixed number of iterations and hope for the best.</p>
<p>Furthermore, we can implement springs as well as sticks by replacing <a class="el" href="#equation4">Equation (4)</a> with <a class="anchor" id="equation5"></a> </p><p class="formulaDsp">
\[
c = r(1 - d/\Vert\vec{v}\Vert)
\tag{5}
\]
</p>
<p> where \(0 &lt; r \leq 1\) is called the <em>restitution</em>, which is a measure of the stiffness of the spring, where a stick has restitution 1.</p>
<p>In our code each point will be implemented as an instance of <code><a class="el" href="class_c_point.html" title="The point.">CPoint</a></code>. <code><a class="el" href="class_c_point.html#a0fc7702172f5577d1ffc8376f6cefed6" title="Change position depending on time and velocity.">CPoint::move</a></code> moves the point using Verlet integration (see <a class="el" href="#section5-1">Section 5.1</a>) Each spring will be implemented as an instance of <code><a class="el" href="class_c_spring.html" title="The spring.">CSpring</a></code>. <code><a class="el" href="class_c_spring.html#afee2fe84fe7fb9104b730973ed815e5d" title="Gauss-Seidel relaxation.">CSpring::Relax</a></code> performs one iteration of <em>Jacobi-Gauss-Seidel</em> relaxation using <a class="el" href="#equation5">Equation (5)</a>. Sticks will be instances of <code><a class="el" href="class_c_spring.html" title="The spring.">CSpring</a></code> with private member variable <code><a class="el" href="class_c_spring.html#a7acd8bd0f964ef7153be89f229d4aa83" title="Springiness, between 0.0f and 1.0f.">CSpring::m_fRestitution</a></code> = 1.</p>
<p><a class="anchor" id="section5-3"></a></p><h2>5.3 Bodies</h2>
<p>A <em>body</em> is a collection of points and springs connecting those points. It will be represented as an instance of <code><a class="el" href="class_c_body.html" title="The body.">CBody</a></code>, which has member variables made up of pointers to instances of <code><a class="el" href="class_c_spring.html" title="The spring.">CSpring</a></code> and <code><a class="el" href="class_c_point.html" title="The point.">CPoint</a></code>. There are three kinds of body, each of which is derived from <code><a class="el" href="class_c_body.html" title="The body.">CBody</a></code>. <code><a class="el" href="class_c_chain.html" title="The chain.">CChain</a></code> is a chain of connected points, as in <a class="el" href="#fig10">Fig. 10</a>. Note that there are two instances of <code><a class="el" href="class_c_body.html" title="The body.">CBody</a></code> drawn there, one made up of sticks and the other springs. Successive levels show chains of 2, 3, and 4 points. <code><a class="el" href="class_c_chain.html" title="The chain.">CChain</a></code> consists of just a constructor that puts the points in the right position and connects them with sticks or springs as required.</p>
<p><a class="anchor" id="fig10"></a></p><div class="image">
<img src="chain.png" alt="" width="50%"/>
<div class="caption">
Fig. 10: Three-point chains made of sticks (left) and springs (right).</div></div>
<p><code><a class="el" href="class_c_wheel.html" title="The wheel.">CWheel</a></code> is a circle of points connected to a central point which acts as a hub. Successive levels show wheels that are square, pentagonal, and hexagonal. <a class="el" href="#fig11">Fig. 11</a> shows a pentagonal wheel. <code><a class="el" href="class_c_wheel.html" title="The wheel.">CWheel</a></code> consists of just a constructor that puts the points in the right position and connects them with sticks or springs as required.</p>
<p><a class="anchor" id="fig11"></a></p><div class="image">
<img src="wheel.png" alt="" width="40%"/>
<div class="caption">
Fig. 11: Pentagonal wheel made of sticks (left) and springs (right).</div></div>
<p>Finally, Woody the ragdoll robot (see <a class="el" href="#fig12">Fig. 12</a>) is an instance of <code><a class="el" href="class_c_ragdoll.html" title="The ragdoll.">CRagdoll</a></code> made up of both sticks and springs. In addition to the constructor, <code><a class="el" href="class_c_ragdoll.html" title="The ragdoll.">CRagdoll</a></code> has various functions that implement the rule-based AI that makes it jump back onto its feet after it has fallen (see <a class="el" href="#fig3">Fig. 3</a>).</p>
<p><a class="anchor" id="fig12"></a></p><div class="image">
<img src="robot0.png" alt="" width="15%"/>
<div class="caption">
Fig. 12: Woody the ragdoll robot.</div></div>
<p><a class="anchor" id="section6"></a></p><h1>6. What Next?</h1>
<p>Next, take a look at the <a href="../box2drender/index.html">Box2D Render Library</a>. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
