<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Box2D Cannon Game With Stars: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="sagedoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="cannon.png"/></td>
  <td id="projectalign">
   <div id="projectname">Box2D Cannon Game With Stars
   </div>
   <div id="projectbrief">Game Physics with a 2D Physics Engine</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="contents">
<div class="textblock"><p><a class="anchor" id="section1"></a></p><h1>1. Introduction</h1>
<p>This version of the <a href="../cannon/index.html">Box2D Cannon Game</a> uses a Box2D contact listener to play the right collision sounds and animate colored stars at the points of contact. The stars remain fixed in world space at the point of first collision, and grow and shrink again over time. The color of each star is determined by the type of the objects colliding. An example snapshot can be seen in <a class="el" href="#fig1">Fig. 1</a>. <br  />
</p>
<p><a class="anchor" id="fig1"></a></p><div class="image">
<img src="screenshot.png" alt="" width="60%"/>
<div class="caption">
Fig. 1: Stars at collision points.</div></div>
<p>The remainder of this page is divided into five sections. <a class="el" href="#section2">Section 2</a> lists the controls and their corresponding actions, <a class="el" href="#section3">Section 3</a> tells you how to build it, <a class="el" href="#section4">Section 4</a> gives you a list of actions to take in the game to see some of its important features, <a class="el" href="#section5">Section 5</a> gives a breakdown of the code, and <a class="el" href="#section6">Section 6</a> addresses the question "what next?".</p>
<p><a class="anchor" id="section2"></a></p><h1>2. Keyboard Controls</h1>
<center> <table class="doxtable">
<tr>
<td><center><b>Key</b></center> </td><td><center><b>Action</b></center> </td></tr>
<tr>
<td><center>F1</center> </td><td>Help (this document) </td></tr>
<tr>
<td><center>F2</center> </td><td>Toggle draw mode from "sprites only", to "sprites and lines", to "lines only" </td></tr>
<tr>
<td><center>Enter</center> </td><td>Restart when over </td></tr>
<tr>
<td><center>Space</center> </td><td>Fire cannon </td></tr>
<tr>
<td><center>Up arrow</center> </td><td>Rotate cannon barrel up while key is depressed </td></tr>
<tr>
<td><center>Down arrow</center> </td><td>Rotate cannon barrel down while key is depressed </td></tr>
<tr>
<td><center>Left arrow</center> </td><td>Start cannon moving left </td></tr>
<tr>
<td><center>Right arrow</center> </td><td>Start cannon moving right </td></tr>
<tr>
<td><center>S</center> </td><td>Stop cannon </td></tr>
<tr>
<td><center>PrtScr (hold down)</center> </td><td>Save screenshot to a PNG file </td></tr>
<tr>
<td><center>Esc</center> </td><td>Quit game and close the window </td></tr>
</table>
</center><p><a class="anchor" id="section3"></a></p><h1>3. Building the Game</h1>
<p>This code uses <a href="../sage/index.html">SAGE</a> and <a href="https://github.com/erincatto/Box2D">Box2D</a>. Make sure that you have followed the <a href="../install/index.html">SAGE Installation Instructions</a> and the <a href="../installphysics/index.html">Box2D Installation Instructions</a>. Navigate to the folder <span style="background-color:#D8E4D8;"><code>10. Box2D Cannon Game with Stars</code></span> in your copy of the <span style="background-color:#D8E4D8;"><code>sage-physics</code></span> repository. Run <span style="background-color:#D8E4D8;"><code>checkenv.bat</code></span> to verify that you have set the environment variables correctly. Open <span style="background-color:#D8E4D8;"><code>Box2D Cannon Game with Stars.sln</code></span> with Visual Studio and build the Release configuration. Alternatively, run <span style="background-color:#D8E4D8;"><code>Build.bat</code></span> to build both Release and Debug configurations.</p>
<p><a class="anchor" id="section4"></a></p><h1>4. Game Play</h1>
<p>The same as <a href="../cannon/index.html#section4">Box2D Cannon Game</a> but pay attention to the stars and the sounds.</p>
<p><a class="anchor" id="section5"></a></p><h1>5. Code Breakdown</h1>
<p>The code for this game is almost identical to that of the <a href="../cannon/index.html">Box2D Cannon Game</a> except that the kluged code for playing collision sounds has been removed and code for a Box2D <em>contact listener</em> has been added. In order to use a Box2D contact listener you must derive a class from <code>b2ContactListener</code> and override its <code>PreSolve</code> function </p><pre class="fragment">void PreSolve(b2Contact*, const b2Manifold*);
</pre><p> which will be called by Box2D once per physics iteration after collisions (called <em>contacts</em> in Box2D) have been calculated. Our contact listener is called <code><a class="el" href="class_c_my_listener.html" title="My contact listener.">CMyListener</a></code>. The first parameter of <code><a class="el" href="class_c_my_listener.html#a9cfe3dcfe49fbe4a73ba722a524b7123" title="Presolve function.">CMyListener::PreSolve</a></code> is a pointer to a <em>contact</em>, which contains information about the fixtures involved in the collision. The second parameter of <code><a class="el" href="class_c_my_listener.html#a9cfe3dcfe49fbe4a73ba722a524b7123" title="Presolve function.">CMyListener::PreSolve</a></code> is a pointer to a <em>contact manifold</em>, which contains information about the collision itself. Our parameters are named as follows: </p><pre class="fragment">void CMyListener::PreSolve(b2Contact* pContact, const b2Manifold* pManifold);
</pre><p> Getting the information that we need to play sounds and place stars (mainly the coordinates of the point or points of contact, the types of the objects colliding, and the speed of collision) is a little obscure. Keep in mind that in the code described below, that we will follow Box2D's convention of referring to the fixtures, bodies, and objects colliding as fixture/body/object A, and fixture/body/object B.</p>
<p>Note that in Box2D there can be either one point of contact (for example, a circle colliding with a polygon as in <a class="el" href="#fig2">Fig. 2</a>, left) or two points of contact (for example, a polygon edge colliding with a polygon edge as in <a class="el" href="#fig2">Fig. 2</a>, right).</p>
<p><a class="anchor" id="fig2"></a></p><div class="image">
<img src="1or2pts.png" alt="" width="30%"/>
<div class="caption">
Fig. 2: There can be one (left) or two (right) contact points.</div></div>
<p>The first thing you need to do is convert the <code>b2Manifold</code> to an instance of <code>b2WorldManifold</code>, which has the coordinates of the contacts in world space. </p><pre class="fragment">b2WorldManifold wm;
pContact-&gt;GetWorldManifold(&amp;wm);
</pre><p> Next, you need to get the <em>point_state</em> of the contact point or points, a member of an enumerated type <code>b2PointState</code> that can be one of four values: <code>b2_nullState</code> (point not in use). <code>b2_addState</code> (collision point is new) <code>b2_persistState</code> (collision point was previously reported) <code>b2_removeState</code> (previously reported collision point has been removed). We declare two local variables to hold these point states. There are two variables because we will need one for the point states before the collision and one for the point state after it. We will call these <code>state1</code> and <code>state2</code>, respectively. Both local variables need to be an array of size two, with one entry for each possible contact point. We get these values by calling <code>b2GetPointStates</code> as follows. </p><pre class="fragment">b2PointState state1[2], state2[2];
b2GetPointStates(state1, state2, pManifold, pContact-&gt;GetManifold());
</pre><p> Note that the point states in <code>state1</code> are either <code>b2_persistState</code>, <code>b2_removeState</code>, or <code>b2_nullState</code>; whereas the point states in <code>state2</code> are either <code>b2_persistState</code>, <code>b2_addState</code>, or <code>b2_nullState</code>. When we see a point state of <code>b2_addState</code> in <code>state2</code>, we are ready to make a sound and create a star particle. The contact point in Physics World Space is <code>wm.points[0]</code>. That's the point at which we will play the sound and create the star in Render World space. We can get pointers to the colliding bodies by calling </p><pre class="fragment">m_pBodyA = pContact-&gt;GetFixtureA()-&gt;GetBody(); 
m_pBodyB = pContact-&gt;GetFixtureB()-&gt;GetBody(); 
</pre><p> The velocity of the first body is obtained by calling </p><pre class="fragment">m_pBodyA-&gt;GetLinearVelocityFromWorldPoint(p);
</pre><p> where <code>p</code> is an arbitrary point (and similarly for the second body). The speed of collision, which is used to set the sound volume for the collision sounds, is then the magnitude of the difference between these vectors multiplied by a scale factor.</p>
<p>We also need to get the sprite type <code>eSprite</code> of each colliding body so that we can change the sound emitted and the color of the star depending on what type of objects are colliding. This seems impossible at first since this code is being executed by Box2D, which is a precompiled library that has no idea about your code for types and classes. Fortunately, Box2D has a provision for this. The Box2D body class <code>m_userData</code> has a field <code>m_userData</code> of type <code>b2BodyUserData</code>, which has a single field <code>pointer</code> of type <code>uintptr_t</code>, which is an unsigned 64-bit integer. We can use this to store a pointer to a newly created object in the Box2D body as follows. Suppose <code>t</code> is of type <code>eSprite</code> and <code>p</code> is a pointer to its <code>b2Body</code>. To create the object, call </p><pre class="fragment">CObject* pObj = new CObject(t, p);
</pre><p> The user data field in the body pointed to by <code>p</code> is set to <code>pObj</code> as follows: </p><pre class="fragment">p-&gt;GetUserData().pointer = (uintptr_t)pObj;
</pre><p> Returning to the contact listener code, we get a pointer to the object of body A by calling <code>b2Body::GetUserData</code> and type-casting the pointer field back to a pointer to <code><a class="el" href="class_c_object.html" title="The game object.">CObject</a></code>.</p>
<p>CObject* objA = (CObject*)m_pBodyA-&gt;GetUserData().pointer;</p>
<p>I hope I don't have to explain to you how dangerous this is. After all, a bug in your code could set the user data field to just about any garbage, resulting in a bad pointer when it is cast to <code>CObject*</code>. All I can see is <em>be_careful</em> when doing this. We can get the sprite type of body A by calling <code><a class="el" href="class_c_object.html#aaa8e01de1643e10f7ff340dda8526287" title="Get sprite type.">CObject::GetSpriteType</a></code>.</p>
<p>We now have all the information that we need to play collision sounds and create stars at the contact points, keeping in mind that the pair of colliding objects can be in any order. To make a particular sound when a ball collides with anything, you must allow for the possibility that object A is the ball (and object B is not), and object B is the ball (and object A is not).</p>
<p><a class="anchor" id="section6"></a></p><h1>6. What Next?</h1>
<p>Next, take a look at the <a href="../box2dblank/index.html">Box2D Blank Game</a>. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
